name: Build and Deploy OmniPOS

on:
  push:
    branches: [ main, beta ]

env:
  REGISTRY: ghcr.io
  API_IMAGE_NAME: ${{ github.repository }}-api
  WEB_IMAGE_NAME: ${{ github.repository }}-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./OmniPOS.Api
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}:latest

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./OmniPOS.Web-React
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 20m
          script: |
            echo "--- System Check ---"
            docker --version
            
            echo "--- Safe Project Update ---"
            
            echo "--- Project Update ---"
            mkdir -p /root/omnipos && cd /root/omnipos
            if [ -d ".git" ]; then
              git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git
              git fetch --all
              git reset --hard origin/${{ github.ref_name }}
            else
              git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git .
            fi
            
            echo "--- Registry Login & Pull ---"
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose pull
            
            echo "--- Launching Containers ---"
            docker compose up -d
            
            echo "--- Automated SSL Check ---"
            if [ ! -f "/root/omnipos/certbot/conf/live/POS.kematconsulting.co.uk/fullchain.pem" ]; then
              echo "Requesting SSL Certificate (Non-blocking)..."
              timeout 5m docker compose run --rm certbot certonly --webroot --webroot-path /var/www/certbot/ --email admin@kematconsulting.co.uk --agree-tos --no-eff-email -d POS.kematconsulting.co.uk || echo "SSL Request timed out or failed"
              docker compose restart web
            fi
            
            echo "--- Fixing SSL Permissions for Host Nginx ---"
            chmod 755 /root
            chmod 755 /root/omnipos
            chmod -R 755 /root/omnipos/certbot/conf/live
            chmod -R 755 /root/omnipos/certbot/conf/archive
            
            echo "--- Restoring Host Services ---"
            systemctl start nginx || echo "Failed to start host nginx"
            
            docker ps
            
            echo "--- Cleaning up old images ---"
            docker system prune -af
